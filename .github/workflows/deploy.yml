name: Manual Deploy Hono API

on:
  workflow_dispatch: # This is the ONLY trigger now

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Build Hono App
        run: |
          npm ci
          npm run build

      - name: Sync Production Files to Lightsail
        uses: Burnett01/rsync-deployments@v7
        with:
          # Exclude node_modules, .git, and ALL local database files
          switches: -avzr --delete --exclude='node_modules/' --exclude='.git/' --exclude='*.db*' --exclude='src/'
          path: ./
          remote_path: /home/ubuntu/app/
          remote_host: ${{ secrets.LIGHTSAIL_IP }}
          remote_user: ubuntu
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Server-Side Migration & Restart
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.LIGHTSAIL_IP }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/ubuntu/app
            npm install --production --no-audit --no-fund

            # Update DB Schema (Drizzle)
            npx drizzle-kit push:sqlite

            # Reload PM2 (Zero-downtime reload if possible)
            pm2 reload hono-api || pm2 start dist/index.js --name "hono-api"

      - name: Invalidate CloudFront
        uses: chetan/invalidate-cloudfront-action@v2
        env:
          DISTRIBUTION: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
          PATHS: "/*"
          AWS_REGION: "us-east-1"
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
